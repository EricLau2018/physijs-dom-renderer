<!DOCTYPE html>
<html>
    <head>
      <title>Rigid body - Physijs</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
      <style type="text/css">
        svg {
          border: 2px solid black;
          background-color: blue;
          margin: 10px;
          opacity: .8
        }
        circle {
          fill: tomato;
          opacity: .5;
        }
      </style>
    </head>
    <body>
      <div id="viewport"></div>
      <script type="text/javascript" src="lib/d3.min.js"></script>
      <script type="text/javascript" src="lib/three.min.js"></script>
      <script type="text/javascript" src="lib/CSS3D-renderer.js"></script>
      <script type="text/javascript" src="lib/stats.min.js"></script>
      <script type="text/javascript" src="lib/physi.js"></script>
      <script type="text/javascript">
        var data = d3.range(20);
        var counter = 0;

        Physijs.scripts.worker = 'lib/physijs_worker.js';
        Physijs.scripts.ammo = 'ammo.small.js';

        var scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3(0, -10, 0));

        var renderer = new THREE.CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute';
        document.getElementById('viewport').appendChild(renderer.domElement);

        var camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight , 1, 1000);
        camera.position.z = 1000;
        camera.setLens(60);
        scene.add(camera);

        var render_stats = new Stats();
        render_stats.domElement.style.position = 'absolute';
        render_stats.domElement.style.top = '1px';
        render_stats.domElement.style.zIndex = 100;
        document.getElementById('viewport').appendChild(render_stats.domElement);

        var container = d3.select("#viewport");

        container.selectAll(".chart")
          .data(data).enter()
            .append("svg")
              .attr("class", "chart")
              .attr("height", "150px")
              .attr("width", "150px")
              .attr("id", function (d) { return "chart-" + d; })
              .each(function () {
                d3.select(this).append("circle")
                  .attr("r", function (d) { return d * 4; })
                  .attr("cx", 75)
                  .attr("cy", 75)
              })
              .each(setData)
              .each(createCSS3D)
              .on("click", function () {
                d3.select(this)
                  .style("background-color", "aliceblue")
              });

        render();

        function setData (d) {
          var obj = {value: d, name: "chart-" + d};
          var x = Math.random() * 4000 - 2000;
          var y = Math.random() * 4000 - 2000;
          var z = Math.random() * 4000 - 2000;
          obj['random'] = new THREE.Vector3(-(80 * d + 1), 50, 80 * d + 1);

          d3.select(this).datum(obj);
        }

        function createCSS3D(d) {
          var geom = new THREE.CubeGeometry(150, 150, 4);
          var mtrl = new THREE.MeshBasicMaterial({wireframe: true});
          var object = new Physijs.BoxMesh(geom, mtrl, 5);
          object.rotation.set((Math.random() * 500 - 25) - 300, (20 + Math.random() * 50) + 400, Math.random() * 500 - 25);
          object.position.set((Math.random() * 1000 - 25) - 200, (20 + Math.random() * 50) + 300, Math.random() * 500 - 25);
          object.name = "chart-" + d.value;
          scene.add(THREE.CSS3DObject.call(object, this));
        }

        function render() {
          requestAnimationFrame(render);
          renderer.render(scene, camera);
          render_stats.update();
          scene.simulate(undefined, 1);
        }
      </script>
    </body>
</html>